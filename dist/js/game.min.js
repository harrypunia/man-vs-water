function listenToPlayer(e){e.val()&&otherPlayers[e.key].setOrientation(e.val().orientation.position,e.val().orientation.rotation)}function initOtherPlayers(){ref.on("child_added",function(e){e.val()&&(playerId==e.key||otherPlayers[e.key]||(otherPlayers[e.key]=new Player(e.key),otherPlayers[e.key].init(),ref.child(e.key).on("value",listenToPlayer)))}),ref.on("child_removed",function(e){e.val()&&(ref.child(e.key).off("value",listenToPlayer),scene.remove(otherPlayers[e.key].mesh),delete otherPlayers[e.key])})}function initMainPlayer(){playerId=ref.push().key,ref.child(playerId).child("orientation").set({position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0}}),player=new Player(playerId,playerName,playerType),player.isMainPlayer=!0,player.init()}function loadMapsize(){"large"==arenaSizeSelected?arenaSize=300:"medium"==arenaSizeSelected?arenaSize=225:arenaSize=150,meshShrinkSpeed=shrinkSpeed/arenaSize}function restrictPlayer(e){e.position.x<=-(arenaSize/2-.5)?e.position.x=-(arenaSize/2-.5):e.position.x>=arenaSize/2-.5&&(e.position.x=arenaSize/2-.5),e.position.z<=-(arenaSize/2-.5)?e.position.z=-(arenaSize/2-.5):e.position.z>=arenaSize/2-.5&&(e.position.z=arenaSize/2-.5)}function playerFall(){0==controls.hasLanded&&player.mesh.position.y>1&&(controls.update(),controls.access(4,.5,4),player.mesh.position.y--,player.mesh.position.y<=2&&(player.mesh.position.y=.5,controls.access(4,.5,4),controls.hasLanded=!0))}function removePlayers(){window.onunload=function(){ref.child(playerId).remove()},window.onbeforeunload=function(){ref.child(playerId).remove()}}function arenaShrink(){if(arenaSize>50)zone.shrink(meshShrinkSpeed),arenaSize-=shrinkSpeed;else if(arenaSize<=50)return!1}function updateLight(){sun.position.set(player.mesh.position.x+arenaSize/4,100,player.mesh.position.z+arenaSize/4)}environment=new Environment;var Game=function(){this.init=function(){setAudioPara(),loadMapsize(),initMainPlayer(),initOtherPlayers(),environment.init(),controls.init()},this.update=function(){playerFall(),removePlayers(),updateLight(),walls.applyPhysics(.2),bulletPhysics(walls.list,bulletSize),arenaShrink(),player.restrict(player.mesh)}};